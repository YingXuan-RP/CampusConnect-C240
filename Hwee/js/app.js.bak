/* App behaviors for PeerSupportSite
   - Mood selector (persists to localStorage)
   - Show wellbeing tips (JS-generated)
   - Lightweight accessibility and simple animations
*/

/* Flowise API Query Function */
async function queryFlowise(data) {
    const response = await fetch(
        "https://cloud.flowiseai.com/api/v1/prediction/a7d8418d-c0f1-4750-a927-2e7107d173a3",
        {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        }
    );
    const result = await response.json();
    return result;
}

/* Chatbot Widget Functionality */
document.addEventListener('DOMContentLoaded', function () {
    const chatbotWidget = document.getElementById('chatbotWidget');
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotContent = document.querySelector('.chatbot-content');
    const closeChatbot = document.getElementById('closeChatbot');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const chatMessages = document.getElementById('chatMessages');

    if (chatbotToggle && chatbotContent) {
        // OPEN CHATBOT BY DEFAULT
        setTimeout(() => {
            chatbotContent.classList.add('active');
            chatbotToggle.classList.add('hidden');
            chatInput.focus();
        }, 500);

        // Toggle chat open/close
        chatbotToggle.addEventListener('click', function () {
            chatbotContent.classList.toggle('active');
            chatbotToggle.classList.toggle('hidden');
            if (chatbotContent.classList.contains('active')) {
                chatInput.focus();
            }
        });

        // Close chat
        closeChatbot.addEventListener('click', function () {
            chatbotContent.classList.remove('active');
            chatbotToggle.classList.remove('hidden');
        });

        // Send message on button click
        sendChatBtn.addEventListener('click', sendMessage);

        // Send message on Enter key
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send message function
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            chatInput.value = '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot';
            typingDiv.innerHTML = '<div class="message-bubble bot">Thinking...</div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Query Flowise API with the exact format
                const response = await queryFlowise({ question: message });

                console.log('Full API Response:', response);

                // Remove typing indicator
                typingDiv.remove();

                // Handle different response formats from Flowise
                let botMessage = '';

                if (response.text) {
                    botMessage = response.text;
                } else if (response.message) {
                    botMessage = response.message;
                } else if (response.answer) {
                    botMessage = response.answer;
                } else if (typeof response === 'string') {
                    botMessage = response;
                } else if (response.error) {
                    botMessage = `Error: ${response.error}`;
                } else {
                    botMessage = JSON.stringify(response);
                }

                if (botMessage) {
                    addMessageToChat(botMessage, 'bot');
                } else {
                    addMessageToChat('I received your message but didn\'t get a response.', 'bot');
                }
            } catch (error) {
                typingDiv.remove();
                console.error('Chat error:', error);
                addMessageToChat(`Sorry, I'm having trouble connecting. Error: ${error.message}`, 'bot');
            }
        }

        // Add message to chat display
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<div class="message-bubble ${sender}">${escapeHtml(text)}</div>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }
});

const moodOptions = document.getElementById('moodOptions');
const moodMessage = document.getElementById('moodMessage');
const showTipsBtn = document.getElementById('showTips');
const tipsList = document.getElementById('tipsList');
const themeToggle = document.getElementById('themeToggle');
const navToggle = document.getElementById('navToggle');
const siteNav = document.querySelector('.site-nav');
const journalInput = document.getElementById('journalInput');
const saveEntry = document.getElementById('saveEntry');
const moodHistory = document.getElementById('moodHistory');
const clearHistory = document.getElementById('clearHistory');
const breathBtn = document.getElementById('breathBtn');
const breathModal = document.getElementById('breathModal');
const breathText = document.getElementById('breathText');
const breathCounter = document.getElementById('breathCounter');
const stopBreath = document.getElementById('stopBreath');
const exportBtn = document.getElementById('exportData');
const importInput = document.getElementById('importData');

const TIPS = [
    'Take a 5-minute breathing break: inhale slowly for 4, exhale for 6.',
    'Try the 5-4-3-2-1 grounding exercise: name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, 1 you taste.',
    'Break tasks into smaller steps and celebrate each small win.',
    'Reach out to a friend or study buddy ‚Äî sharing can make things feel lighter.',
    'If feelings feel overwhelming, consider contacting campus counselling or a trusted person.'
];

const MOOD_RESPONSES = {
    calm: 'Nice ‚Äî it sounds like you are feeling steady. Maintain small, positive routines.',
    sad: 'I hear you. It can help to name one small thing that feels manageable right now.',
    anxious: 'When anxiety rises, try a grounding exercise or slow breaths for a minute.',
    stressed: 'Stress can build up. Short breaks and micro-rests can reduce pressure.',
    neutral: 'Thanks for checking in. Small self-care steps can shift your day.'
};

/* Toast / temporary messages + undo support */
const toastContainer = document.getElementById('toastContainer');
function showToast(message, opts = {}) {
    if (!toastContainer) {
        // fallback
        try { alert(message); } catch (e) { console.log(message); }
        return;
    }
    const ttl = opts.ttl || 7000;
    const toast = document.createElement('div'); toast.className = 'toast';
    const msg = document.createElement('div'); msg.className = 'msg'; msg.textContent = message;
    toast.appendChild(msg);
    if (opts.actionLabel && typeof opts.action === 'function') {
        const btn = document.createElement('button'); btn.className = 'undo'; btn.textContent = opts.actionLabel;
        btn.addEventListener('click', () => { try { opts.action(); } catch (e) { /* ignore */ } finally { toast.remove(); } });
        toast.appendChild(btn);
    }
    const close = document.createElement('button'); close.className = 'close'; close.innerHTML = '‚úï';
    close.addEventListener('click', () => toast.remove());
    toast.appendChild(close);
    toastContainer.appendChild(toast);
    if (ttl > 0) setTimeout(() => { try { toast.remove(); } catch (e) { } }, ttl);
    return toast;
}

function saveMood(mood) {
    try { localStorage.setItem('peersupport:mood', mood); }
    catch (e) { }
}
function loadMood() {
    try { return localStorage.getItem('peersupport:mood'); }
    catch (e) { return null }
}

function setSelected(button) {
    // clear previous
    Array.from(moodOptions.querySelectorAll('.mood')).forEach(b => {
        b.classList.remove('selected');
        b.setAttribute('aria-pressed', 'false');
    });
    if (button) {
        button.classList.add('selected');
        button.setAttribute('aria-pressed', 'true');
    }
}

function renderMoodMessage(mood) {
    const text = MOOD_RESPONSES[mood] || '';
    moodMessage.textContent = text;
}

// attach events to mood buttons
if (moodOptions) {
    moodOptions.addEventListener('click', (e) => {
        const btn = e.target.closest('.mood');
        if (!btn) return;
        const mood = btn.dataset.mood;
        setSelected(btn);
        renderMoodMessage(mood);
        saveMood(mood);
    });

    // keyboard support
    moodOptions.addEventListener('keydown', (e) => {
        const focused = document.activeElement;
        if (!focused.classList || !focused.classList.contains('mood')) return;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault(); const next = focused.nextElementSibling || moodOptions.firstElementChild; next.focus();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault(); const prev = focused.previousElementSibling || moodOptions.lastElementChild; prev.focus();
        } else if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault(); focused.click();
        }
    });

    // restore mood
    const prev = loadMood();
    if (prev) {
        const btn = moodOptions.querySelector(`.mood[data-mood="${prev}"]`);
        if (btn) setSelected(btn), renderMoodMessage(prev);
    }
}

// Tips toggling and random tip generation (show one random tip)
if (showTipsBtn && tipsList) {
    showTipsBtn.addEventListener('click', () => {
        const showing = !tipsList.hidden;
        if (showing) {
            tipsList.hidden = true;
            showTipsBtn.textContent = 'View Wellbeing Tips';
        } else {
            // choose a random tip
            const idx = Math.floor(Math.random() * TIPS.length);
            const tip = TIPS[idx];
            tipsList.innerHTML = '';
            const li = document.createElement('li');
            li.textContent = tip;
            tipsList.appendChild(li);
            tipsList.hidden = false;
            showTipsBtn.textContent = 'Hide Tip';
            // smooth reveal and move into view
            tipsList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });
    // keyboard: Enter/Space on button already handled by browser
}

// Mobile nav toggle
if (navToggle && siteNav) {
    navToggle.addEventListener('click', () => {
        const open = siteNav.classList.toggle('open');
        navToggle.setAttribute('aria-expanded', String(open));
    });
    // close menu when a nav link is clicked
    siteNav.addEventListener('click', (e) => { if (e.target.tagName === 'A') { siteNav.classList.remove('open'); navToggle.setAttribute('aria-expanded', 'false'); } });
    // close on escape
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { siteNav.classList.remove('open'); navToggle.setAttribute('aria-expanded', 'false'); } });
}

/* Theme (dark) */
function saveTheme(t) {
    try { localStorage.setItem('peersupport:theme', t); } catch (e) { }
}
function loadTheme() { try { return localStorage.getItem('peersupport:theme'); } catch (e) { return null } }
function applyTheme(t) {
    const on = t === 'dark';
    document.documentElement.classList.toggle('dark', on);
    if (themeToggle) themeToggle.setAttribute('aria-pressed', String(on));
}
if (themeToggle) {
    const saved = loadTheme();
    applyTheme(saved || 'light');
    themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        saveTheme(isDark ? 'dark' : 'light');
        themeToggle.setAttribute('aria-pressed', String(isDark));
    });
}

/* Journal / history */
function loadJournal() {
    try { const raw = localStorage.getItem('peersupport:journal'); if (!raw) return []; return JSON.parse(raw); } catch (e) { return [] }
}
function saveJournal(arr) {
    try { localStorage.setItem('peersupport:journal', JSON.stringify(arr)); } catch (e) { }
}
function renderHistory() {
    if (!moodHistory) return;
    const items = loadJournal();
    moodHistory.innerHTML = '';
    items.slice().reverse().forEach(it => {
        const li = document.createElement('li');
        const t = document.createElement('time'); t.textContent = new Date(it.when).toLocaleString();
        li.appendChild(t);
        const p = document.createElement('div'); p.textContent = `${it.mood ? '[' + it.mood + '] ' : ''}${it.note || ''}`;
        li.appendChild(p);
        moodHistory.appendChild(li);
    });
}
if (saveEntry) {
    saveEntry.addEventListener('click', () => {
        const note = (journalInput && journalInput.value || '').trim();
        const selected = moodOptions && moodOptions.querySelector('.mood.selected');
        const mood = selected ? selected.dataset.mood : 'unspecified';
        const arr = loadJournal();
        arr.push({ when: new Date().toISOString(), mood, note });
        // keep only recent 60
        if (arr.length > 60) arr.splice(0, arr.length - 60);
        saveJournal(arr);
        renderHistory();
        if (journalInput) journalInput.value = '';
        showToast('Entry saved', { ttl: 3000 });
    });
}
// Undoable clear for journal
let lastClearedJournal = null;
let lastClearedTimer = null;
if (clearHistory) {
    clearHistory.addEventListener('click', () => {
        const arr = loadJournal();
        if (!arr || !arr.length) { showToast('No entries to clear', { ttl: 2500 }); return; }
        // backup
        lastClearedJournal = arr.slice();
        saveJournal([]);
        renderHistory();
        // offer undo
        if (lastClearedTimer) { clearTimeout(lastClearedTimer); lastClearedTimer = null; }
        lastClearedTimer = setTimeout(() => { lastClearedJournal = null; lastClearedTimer = null; }, 8000);
        showToast('History cleared', {
            actionLabel: 'Undo', action: () => {
                if (lastClearedJournal) { saveJournal(lastClearedJournal); renderHistory(); lastClearedJournal = null; if (lastClearedTimer) { clearTimeout(lastClearedTimer); lastClearedTimer = null; } showToast('History restored', { ttl: 3000 }); }
            }, ttl: 8000
        });
    });
}
renderHistory();

/* Testimonials (student stories) and Quotes (micro-blog) */
const testimonialsList = document.getElementById('testimonialsList');
const testimonialForm = document.getElementById('testimonialForm');
const addTestimonialBtn = document.getElementById('addTestimonial');
const testName = document.getElementById('testName');
const testText = document.getElementById('testText');

const quotesListEl = document.getElementById('quotesList');
const quoteForm = document.getElementById('quoteForm');
const addQuoteBtn = document.getElementById('addQuote');
const quoteName = document.getElementById('quoteName');
const quoteText = document.getElementById('quoteText');

function loadTestimonials() { try { const raw = localStorage.getItem('peersupport:testimonials'); return raw ? JSON.parse(raw) : []; } catch (e) { return [] } }
function saveTestimonials(arr) { try { localStorage.setItem('peersupport:testimonials', JSON.stringify(arr)); } catch (e) { } }
function loadQuotes() { try { const raw = localStorage.getItem('peersupport:quotes'); return raw ? JSON.parse(raw) : []; } catch (e) { return [] } }
function saveQuotes(arr) { try { localStorage.setItem('peersupport:quotes', JSON.stringify(arr)); } catch (e) { } }

function createAvatar(name) {
    const initial = (name || '').trim().charAt(0).toUpperCase() || '?';
    const el = document.createElement('div'); el.className = 'avatar'; el.textContent = initial; return el;
}

function renderTestimonialItem(item) {
    const li = document.createElement('li'); li.className = 'testimonial';
    const avatar = createAvatar(item.name);
    const body = document.createElement('div'); body.className = 'body';
    const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `${item.name ? item.name : 'Anonymous'} ‚Äî ${new Date(item.when).toLocaleDateString()}`;
    const p = document.createElement('div'); p.textContent = item.text;
    body.appendChild(meta); body.appendChild(p);
    li.appendChild(avatar); li.appendChild(body);
    return li;
}

function renderQuoteItem(item) {
    const li = document.createElement('li'); li.className = 'quote';
    const avatar = createAvatar(item.name);
    const body = document.createElement('div'); body.className = 'body';
    const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `${item.name ? item.name : 'Anonymous'} ‚Äî ${new Date(item.when).toLocaleDateString()}`;
    const p = document.createElement('div'); p.textContent = item.text;
    body.appendChild(meta); body.appendChild(p);
    li.appendChild(avatar); li.appendChild(body);
    return li;
}

function renderTestimonials() {
    if (!testimonialsList) return;
    const arr = loadTestimonials(); testimonialsList.innerHTML = '';
    arr.slice().reverse().forEach(it => testimonialsList.appendChild(renderTestimonialItem(it)));
}
function renderQuotes() {
    if (!quotesListEl) return;
    const arr = loadQuotes(); quotesListEl.innerHTML = '';
    arr.slice().reverse().forEach(it => quotesListEl.appendChild(renderQuoteItem(it)));
}

if (addTestimonialBtn && testimonialForm) {
    testimonialForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = (testName.value || '').trim();
        const text = (testText.value || '').trim();
        if (!text) { showToast('Please enter a short message', { ttl: 2500 }); return; }
        if (text.length > 600) { showToast('Please shorten your testimonial to under 600 characters.', { ttl: 3500 }); return; }
        const arr = loadTestimonials(); arr.push({ when: new Date().toISOString(), name: name || 'Anonymous', text });
        saveTestimonials(arr);
        testText.value = '';
        testName.value = '';
        renderTestimonials();
        showToast('Thank you ‚Äî story shared', { ttl: 3500 });
    });
}
if (addQuoteBtn && quoteForm) {
    quoteForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = (quoteName.value || '').trim();
        const text = (quoteText.value || '').trim();
        if (!text) { showToast('Please enter a quote', { ttl: 2500 }); return; }
        if (text.length > 140) { showToast('Quote too long (max 140 characters).', { ttl: 3500 }); return; }
        const arr = loadQuotes(); arr.push({ when: new Date().toISOString(), name: name || 'Anonymous', text });
        saveQuotes(arr);
        quoteText.value = '';
        quoteName.value = '';
        renderQuotes();
        showToast('Quote posted', { ttl: 3000 });
    });
}

renderTestimonials(); renderQuotes();

/* Guided breathing */
let breathTimer = null;
let breathPhase = 0;
const BREATH_STEPS = [{ label: 'Breathe in', seconds: 4 }, { label: 'Breathe out', seconds: 6 }];
const BREATH_CYCLES = 4;
function showModal(show) { if (!breathModal) return; breathModal.setAttribute('aria-hidden', String(!show)); }
function stopBreathingRoutine() { if (breathTimer) { clearTimeout(breathTimer); breathTimer = null; } showModal(false); if (breathCounter) breathCounter.textContent = ''; if (breathText) breathText.textContent = ''; }
function startBreathing() {
    if (!breathModal) return; showModal(true); breathPhase = 0; let cycle = 0;
    function step() {
        const s = BREATH_STEPS[breathPhase % BREATH_STEPS.length];
        breathText.textContent = s.label;
        let sec = s.seconds;
        breathCounter.textContent = sec;
        function tick() {
            sec -= 1; if (sec >= 0) { breathCounter.textContent = sec; breathTimer = setTimeout(tick, 1000); } else {
                breathPhase += 1; if (breathPhase % BREATH_STEPS.length === 0) cycle += 1;
                if (cycle >= BREATH_CYCLES) { stopBreathingRoutine(); } else { step(); }
            }
        }
        breathTimer = setTimeout(tick, 1000);
    }
    step();
}
if (breathBtn) { breathBtn.addEventListener('click', () => startBreathing()); }
if (stopBreath) { stopBreath.addEventListener('click', () => stopBreathingRoutine()); }
if (breathModal) { breathModal.addEventListener('click', (e) => { if (e.target === breathModal) stopBreathingRoutine(); }); }

// ensure breathing timer is cleared on page unload to avoid orphaned timers
window.addEventListener('beforeunload', () => { if (breathTimer) { clearTimeout(breathTimer); breathTimer = null; } });

// Export / Import user data (local only). Keys: journal, testimonials, quotes, mood, theme
function gatherExport() {
    return {
        mood: loadMood(),
        theme: loadTheme(),
        journal: loadJournal(),
        testimonials: loadTestimonials(),
        quotes: loadQuotes(),
        exportedAt: new Date().toISOString()
    };
}
function doExport() {
    try {
        const data = gatherExport();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `peersupportsite-export-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('Export downloaded', { ttl: 3000 });
    } catch (err) { showToast('Export failed: ' + (err && err.message)); }
}

function handleImportFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const obj = JSON.parse(String(e.target.result || 'null'));
            if (!obj) { showToast('Imported file appears empty or invalid.'); return; }
            const proceed = confirm('Importing will overwrite local entries for journal, testimonials, quotes, mood and theme. Proceed?');
            if (!proceed) return;
            if (obj.journal) saveJournal(obj.journal);
            if (obj.testimonials) saveTestimonials(obj.testimonials);
            if (obj.quotes) saveQuotes(obj.quotes);
            if (obj.mood) saveMood(obj.mood);
            if (obj.theme) { saveTheme(obj.theme); applyTheme(obj.theme); }
            renderHistory(); renderTestimonials(); renderQuotes();
            // restore selected mood visually
            try {
                const prev = loadMood();
                if (prev && moodOptions) {
                    const btn = moodOptions.querySelector(`.mood[data-mood="${prev}"]`);
                    if (btn) setSelected(btn), renderMoodMessage(prev);
                }
            } catch (er) { }
            showToast('Import complete', { ttl: 3500 });
        } catch (err) { showToast('Import failed: ' + (err && err.message)); }
    };
    reader.readAsText(file);
}

if (exportBtn) { exportBtn.addEventListener('click', doExport); }
if (importInput) { importInput.addEventListener('change', (e) => { const f = e.target.files && e.target.files[0]; if (f) handleImportFile(f); e.target.value = ''; }); }

// lightweight reveal on scroll for cards
if ('IntersectionObserver' in window) {
    const obs = new IntersectionObserver((entries) => {
        entries.forEach(e => {
            if (e.isIntersecting) { e.target.classList.add('reveal'); obs.unobserve(e.target); }
        });
    }, { threshold: 0.12 });
    document.querySelectorAll('.card').forEach(c => obs.observe(c));
}

/* ===== NEW FEATURES: AFFIRMATIONS ===== */
const AFFIRMATIONS = [
    'You are worthy of support and care.',
    'It\'s okay to not be okay. You\'re doing your best.',
    'Your feelings are valid and important.',
    'You deserve kindness, especially from yourself.',
    'Progress, not perfection, is the goal.',
    'You are stronger than you realize.',
    'This moment is temporary. You will get through this.',
    'Asking for help is a sign of strength.',
    'You are not alone in this struggle.',
    'Your voice matters. Your story matters.',
    'Be gentle with yourself. You\'re learning and growing.',
    'You have overcome 100% of your bad days so far.',
    'Your mental health is just as important as your physical health.',
    'Small steps forward are still moving forward.',
    'You are enough, exactly as you are right now.'
];

let currentAffirmationIndex = 0;
const dailyAffirmation = document.getElementById('dailyAffirmation');
const nextAffirmation = document.getElementById('nextAffirmation');

function updateAffirmation() {
    if (dailyAffirmation) {
        dailyAffirmation.textContent = AFFIRMATIONS[currentAffirmationIndex];
        dailyAffirmation.style.animation = 'none';
        setTimeout(() => {
            dailyAffirmation.style.animation = '';
        }, 10);
    }
}

if (nextAffirmation) {
    nextAffirmation.addEventListener('click', () => {
        currentAffirmationIndex = (currentAffirmationIndex + 1) % AFFIRMATIONS.length;
        updateAffirmation();
    });
    updateAffirmation();
}

/* ===== NEW FEATURES: COPING STRATEGIES ===== */
const COPING_STRATEGIES = [
    { name: '4-7-8 Breathing', icon: 'üå¨Ô∏è', desc: 'Breathe in for 4, hold for 7, exhale for 8' },
    { name: '5-4-3-2-1 Grounding', icon: 'üåç', desc: 'Engage all your senses now' },
    { name: 'Progressive Relax', icon: 'üòå', desc: 'Tense and release muscle groups' },
    { name: 'Journaling', icon: 'üìù', desc: 'Write down your thoughts freely' },
    { name: 'Movement', icon: 'üö∂', desc: 'Take a walk, stretch, or dance' },
    { name: 'Nature Time', icon: 'üåø', desc: 'Go outside for fresh air & sunlight' },
    { name: 'Cold Water', icon: 'üßä', desc: 'Splash cold water on your face' },
    { name: 'Positive Playlist', icon: 'üéµ', desc: 'Listen to uplifting music' }
];

const copingStrategies = document.getElementById('copingStrategies');
if (copingStrategies) {
    COPING_STRATEGIES.forEach(strategy => {
        const div = document.createElement('div');
        div.className = 'coping-item';
        div.innerHTML = `
                <div class="coping-icon">${strategy.icon}</div>
                <div class="coping-name">${strategy.name}</div>
                <div class="coping-description">${strategy.desc}</div>
            `;
        div.addEventListener('click', () => {
            showToast(`‚ú® Try: ${strategy.name} - ${strategy.desc}`, { ttl: 5000 });
        });
        copingStrategies.appendChild(div);
    });
}

/* ===== NEW FEATURES: GUIDED EXERCISES ===== */
const EXERCISES = [
    {
        title: 'Body Scan Meditation',
        icon: 'üßò',
        duration: '5 min',
        content: `
                <h4>Body Scan Meditation</h4>
                <p>A gentle technique to release tension and increase awareness.</p>
                <ol class="exercise-steps">
                    <li>Find a comfortable position, lying down or sitting</li>
                    <li>Close your eyes and take 3 deep breaths</li>
                    <li>Starting at your toes, notice any sensations without judging</li>
                    <li>Slowly move attention up through your body</li>
                    <li>When you reach your head, take 3 final deep breaths</li>
                </ol>
            `
    },
    {
        title: 'Grounding Technique',
        icon: 'üåç',
        duration: '3 min',
        content: `
                <h4>5-4-3-2-1 Grounding</h4>
                <p>Instantly connect with your surroundings.</p>
                <ol class="exercise-steps">
                    <li>Name 5 things you can <strong>see</strong></li>
                    <li>Name 4 things you can <strong>touch</strong></li>
                    <li>Name 3 things you can <strong>hear</strong></li>
                    <li>Name 2 things you can <strong>smell</strong></li>
                    <li>Name 1 thing you can <strong>taste</strong></li>
                </ol>
            `
    },
    {
        title: 'Progressive Muscle Relax',
        icon: 'üí™',
        duration: '10 min',
        content: `
                <h4>Progressive Muscle Relaxation</h4>
                <p>Reduce physical tension through systematic muscle release.</p>
                <ol class="exercise-steps">
                    <li>Start with your feet - tense for 5 seconds, then relax</li>
                    <li>Move up to calves, thighs, abdomen, chest</li>
                    <li>Then arms, hands, shoulders, neck, and face</li>
                    <li>Spend time on any areas that feel tight</li>
                    <li>End with 3 deep, calming breaths</li>
                </ol>
            `
    },
    {
        title: 'Mindful Breathing',
        icon: 'üå¨Ô∏è',
        duration: '5 min',
        content: `
                <h4>Mindful Breathing Exercise</h4>
                <p>Calm your nervous system with intentional breathing.</p>
                <ol class="exercise-steps">
                    <li>Sit comfortably with your back straight</li>
                    <li>Breathe in through your nose for a count of 4</li>
                    <li>Hold for a count of 4</li>
                    <li>Exhale through your mouth for a count of 4</li>
                    <li>Repeat 10 times, focusing only on your breath</li>
                </ol>
            `
    },
    {
        title: 'Visualization',
        icon: 'üåÖ',
        duration: '7 min',
        content: `
                <h4>Calming Visualization</h4>
                <p>Transport yourself to a peaceful place mentally.</p>
                <ol class="exercise-steps">
                    <li>Close your eyes and take 3 deep breaths</li>
                    <li>Imagine a safe, peaceful place (beach, forest, mountains)</li>
                    <li>Engage all senses - what do you see, hear, feel?</li>
                    <li>Spend 5 minutes in this peaceful space</li>
                    <li>Slowly return your awareness to the present</li>
                </ol>
            `
    }
];

const exercisesGrid = document.getElementById('exercisesGrid');
const exerciseModal = document.getElementById('exerciseModal');
const exerciseContent = document.getElementById('exerciseContent');
const closeExerciseModal = document.getElementById('closeExerciseModal');
const closeExercise = document.getElementById('closeExercise');

if (exercisesGrid) {
    EXERCISES.forEach(exercise => {
        const card = document.createElement('div');
        card.className = 'exercise-card';
        card.innerHTML = `
                <div class="exercise-icon">${exercise.icon}</div>
                <h4 class="exercise-title">${exercise.title}</h4>
                <p class="exercise-duration">${exercise.duration}</p>
            `;
        card.addEventListener('click', () => {
            exerciseContent.innerHTML = exercise.content;
            exerciseModal.setAttribute('aria-hidden', 'false');
            exerciseModal.style.display = 'flex';
        });
        exercisesGrid.appendChild(card);
    });
}

if (closeExerciseModal) {
    closeExerciseModal.addEventListener('click', () => {
        exerciseModal.setAttribute('aria-hidden', 'true');
        exerciseModal.style.display = 'none';
    });
}
if (closeExercise) {
    closeExercise.addEventListener('click', () => {
        exerciseModal.setAttribute('aria-hidden', 'true');
        exerciseModal.style.display = 'none';
    });
}

/* ===== NEW FEATURES: SELF-CARE ACTIVITIES ===== */
const SELFCARE_ACTIVITIES = [
    { emoji: '‚òï', text: 'Make a warm beverage' },
    { emoji: 'üìö', text: 'Read something you enjoy' },
    { emoji: 'üõÅ', text: 'Take a relaxing bath' },
    { emoji: 'üéµ', text: 'Listen to your favorite song' },
    { emoji: 'üö∂', text: 'Take a short walk' },
    { emoji: '‚úçÔ∏è', text: 'Write in your journal' },
    { emoji: 'üå±', text: 'Care for a plant' },
    { emoji: 'üé®', text: 'Create something' },
    { emoji: 'üìû', text: 'Call someone you care about' },
    { emoji: 'üßò', text: 'Do a 5-minute meditation' },
    { emoji: 'üçå', text: 'Eat a healthy snack' },
    { emoji: 'üé¨', text: 'Watch a favorite show' }
];

const selfcareActivities = document.getElementById('selfcareActivities');
const getSelfcareIdea = document.getElementById('getSelfcareIdea');

function renderSelfcareActivities() {
    if (selfcareActivities) {
        selfcareActivities.innerHTML = '';
        SELFCARE_ACTIVITIES.forEach(activity => {
            const div = document.createElement('div');
            div.className = 'selfcare-item';
            div.innerHTML = `
                    <div class="selfcare-emoji">${activity.emoji}</div>
                    <div class="selfcare-text">${activity.text}</div>
                `;
            div.addEventListener('click', () => {
                showToast(`üíö Great choice! ${activity.text}`, { ttl: 4000 });
            });
            selfcareActivities.appendChild(div);
        });
    }
}

if (getSelfcareIdea) {
    getSelfcareIdea.addEventListener('click', () => {
        const randomIdea = SELFCARE_ACTIVITIES[Math.floor(Math.random() * SELFCARE_ACTIVITIES.length)];
        showToast(`üíö Try this: ${randomIdea.emoji} ${randomIdea.text}`, { ttl: 5000 });
    });
}

renderSelfcareActivities();

/* ===== NEW FEATURES: MOOD PROGRESS TRACKER ===== */
const MOOD_VALUES = { calm: 5, neutral: 3, stressed: 2, anxious: 1, sad: 1 };

function getMoodData() {
    try {
        const data = localStorage.getItem('peersupport:moodData');
        return data ? JSON.parse(data) : {};
    } catch (e) {
        return {};
    }
}

function saveMoodData(data) {
    try {
        localStorage.setItem('peersupport:moodData', JSON.stringify(data));
    } catch (e) { }
}

function updateMoodChart() {
    const moodChart = document.getElementById('moodChart');
    const moodStats = document.getElementById('moodStats');
    if (!moodChart || !moodStats) return;

    const data = getMoodData();
    const today = new Date();
    const week = [];
    let totalMood = 0;
    let count = 0;

    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const key = date.toISOString().split('T')[0];
        const mood = data[key] || 0;
        week.push({ date: key, mood: mood, label: date.toLocaleDateString('en', { weekday: 'short' }) });

        if (mood > 0) {
            totalMood += mood;
            count++;
        }
    }

    moodChart.innerHTML = week.map((day, idx) => {
        const height = (day.mood / 5) * 60 + 'px';
        const color = day.mood === 0 ? '#e2e8f0' :
            day.mood >= 4 ? '#10b981' :
                day.mood >= 3 ? '#3b82f6' :
                    day.mood >= 2 ? '#f59e0b' : '#ef4444';
        return `
                <div class="mood-day">
                    <div class="mood-bar" style="background: ${color}; height: ${height}" title="${day.mood > 0 ? 'Mood: ' + day.mood + '/5' : 'No entry'}"></div>
                    <div class="mood-day-label">${day.label}</div>
                </div>
            `;
    }).join('');

    const avgMood = count > 0 ? (totalMood / count).toFixed(1) : 'No data';
    moodStats.innerHTML = `
            <div class="stat-item">
                <div class="stat-value">${count}</div>
                <div class="stat-label">Entries This Week</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${avgMood}</div>
                <div class="stat-label">Average Mood</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${count > 0 ? week.filter(d => d.mood > 0).length : 0}</div>
                <div class="stat-label">Days Tracked</div>
            </div>
        `;
}

// Hook into mood save to update chart
const originalSaveMood = saveMood;
saveMood = function (mood) {
    originalSaveMood(mood);
    const today = new Date().toISOString().split('T')[0];
    const data = getMoodData();
    data[today] = MOOD_VALUES[mood] || 3;
    saveMoodData(data);
    updateMoodChart();
};

updateMoodChart();

// Expose expanded API
window.PeerSupportSite = {
    TIPS,
    MOOD_RESPONSES,
    AFFIRMATIONS,
    COPING_STRATEGIES,
    EXERCISES,
    SELFCARE_ACTIVITIES,
    startBreathing,
    stopBreathingRoutine,
    renderHistory,
    updateAffirmation,
    updateMoodChart
};

}) ();